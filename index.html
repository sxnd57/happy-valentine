<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Valentine Cinematic - Falling Letters</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Segoe+UI:wght@100;300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <!-- Thêm icon font cho các biểu tượng -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/TextPlugin.min.js"></script>

    <style>
      body {
        margin: 0;
        overflow: hidden;
        background-color: #000;
        font-family:
          "Segoe UI", sans-serif; /* Mặc định dùng font hiện đại cho UI */
        user-select: none;
        -webkit-tap-highlight-color: transparent;
      }
      canvas {
        display: block;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 1;
      }

      /* --- LOVE LOCK SCREEN (Màn hình khóa) --- */
      #lock-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-top: 60px;
        z-index: 1000;
        background: rgba(0, 0, 0, 0.4); /* Nền tối nhẹ để thấy hạt 3D */
        backdrop-filter: blur(3px);
        transition:
          opacity 0.5s,
          transform 0.5s;
        color: #fff;
        cursor: pointer;
      }

      /* Biểu tượng ổ khóa */
      .lock-icon {
        font-size: 1.5rem;
        margin-bottom: 20px;
        opacity: 0.8;
      }

      /* Đồng hồ & Ngày tháng */
      .clock-time {
        font-size: 5.5rem;
        font-weight: 200; /* Font mỏng giống iOS */
        line-height: 1;
        letter-spacing: -2px;
      }
      .clock-date {
        font-size: 1.3rem;
        font-weight: 400;
        margin-top: 10px;
        opacity: 0.9;
      }

      /* Thông báo tình yêu */
      .notification-pill {
        margin-top: 40px;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        padding: 12px 20px;
        border-radius: 15px;
        display: flex;
        align-items: center;
        gap: 15px;
        width: 80%;
        max-width: 320px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        transition: transform 0.2s;
      }
      .notification-pill:active {
        transform: scale(0.98);
      }
      .app-icon {
        width: 40px;
        height: 40px;
        background: #ff0055;
        border-radius: 10px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
      }
      .noti-content {
        display: flex;
        flex-direction: column;
        text-align: left;
      }
      .noti-title {
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 2px;
        display: flex;
        justify-content: space-between;
      }
      .noti-time {
        font-size: 0.75rem;
        opacity: 0.6;
        font-weight: 400;
        margin-left: 10px;
      }
      .noti-msg {
        font-size: 0.9rem;
        opacity: 0.9;
      }

      /* Dòng chữ vuốt để mở */
      .swipe-hint {
        position: absolute;
        bottom: 30px;
        font-size: 1rem;
        opacity: 0.6;
        animation: swipeUp 2s infinite;
        font-weight: 300;
      }

      @keyframes swipeUp {
        0%,
        100% {
          transform: translateY(0);
          opacity: 0.6;
        }
        50% {
          transform: translateY(-10px);
          opacity: 1;
        }
      }

      /* --- KEYPAD SCREEN (Màn hình nhập pass) --- */
      #keypad-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: none; /* Ẩn mặc định */
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(15px); /* Blur mạnh hơn khi nhập pass */
        opacity: 0;
      }

      .enter-pass-text {
        color: #fff;
        font-size: 1.2rem;
        margin-bottom: 30px;
        font-weight: 400;
        letter-spacing: 1px;
      }

      /* Dots indicator (Trái tim) */
      .passcode-dots {
        display: flex;
        gap: 25px;
        margin-bottom: 60px;
      }
      .dot {
        width: 16px;
        height: 16px;
        border: 2px solid #fff;
        border-radius: 50%;
        background: transparent;
        transition: all 0.2s;
        box-sizing: border-box;
      }
      /* Khi nhập thì dot biến thành trái tim */
      .dot.filled {
        background: transparent;
        border: none;
        width: 20px;
        height: 20px;
      }
      .dot.filled::before {
        content: "❤";
        color: #ff0055;
        font-size: 20px;
        line-height: 20px;
        display: block;
      }
      .dot.error {
        border-color: #ff3355;
        background: #ff3355;
        animation: shake 0.3s;
      }

      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-5px);
        }
        75% {
          transform: translateX(5px);
        }
      }

      /* Keypad Grid */
      .keypad {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 25px;
        max-width: 320px;
      }

      .key-btn {
        width: 75px;
        height: 75px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.15);
        border: none;
        color: #fff;
        font-family: "Segoe UI", sans-serif;
        font-size: 2rem;
        font-weight: 300;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: background 0.2s;
        backdrop-filter: blur(5px);
      }
      .key-btn:active {
        background: rgba(255, 255, 255, 0.4);
      }
      .key-btn.transparent {
        background: transparent;
        font-size: 1.2rem;
        font-weight: 500;
      }

      /* --- GREETING OVERLAY (Màn hình chờ sau khi đăng nhập) --- */
      #greeting-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: transparent;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 200;
        pointer-events: none;
      }
      #greeting-overlay h5 {
        color: #ff0055;
        font-family: "Dancing Script", cursive;
        font-size: 2.5rem;
        margin: 0;
        text-shadow: 0 0 30px rgba(255, 0, 85, 0.8);
        text-align: center;
        opacity: 0;
      }
      #greeting-overlay p {
        color: #fff;
        font-family: "Dancing Script", cursive;
        font-size: 1.3rem;
        margin-top: 20px;
        font-weight: 300;
        letter-spacing: 2px;
        max-width: 80%;
        text-align: center;
        line-height: 1.6;
        opacity: 0;
      }

      /* --- MAIN MESSAGE --- */
      #main-message {
        position: fixed;
        top: 10%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80%;
        text-align: center;
        color: #fff0f5;
        font-family: "Dancing Script", cursive;
        font-size: 1rem;
        line-height: 1.6;
        z-index: 150;
        pointer-events: none;
        text-shadow:
          0 0 10px rgba(255, 20, 147, 0.8),
          0 0 20px rgba(255, 20, 147, 0.5);
        opacity: 0;
      }

      @media (max-width: 768px) {
        #main-message {
          font-size: 1rem;
          width: 90%;
        }
        .key-btn {
          width: 68px;
          height: 68px;
          font-size: 1.8rem;
        }
        .keypad {
          gap: 20px;
        }
        .clock-time {
          font-size: 4.5rem;
        }
      }

      /* --- FALLING LETTERS --- */
      #letters-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 100;
        pointer-events: none;
        overflow: hidden;
      }

      .falling-item {
        position: absolute;
        width: 45px;
        height: 45px;
        object-fit: contain;
        cursor: pointer;
        pointer-events: auto;
        filter: drop-shadow(0 0 5px rgba(255, 105, 180, 0.6));
        transition:
          transform 0.1s,
          filter 0.3s;
        will-change: transform;
        top: -100px;
        left: 0;
      }

      .falling-item:hover {
        transform: scale(1.3);
        filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.9));
        z-index: 150;
      }

      /* --- MODAL --- */
      #card-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 300;
        display: none;
        justify-content: center;
        align-items: center;
        opacity: 0;
        backdrop-filter: blur(5px);
      }
      .modal-content {
        background: #fff0f5;
        width: 350px;
        min-height: 250px;
        padding: 30px;
        border-radius: 15px;
        position: relative;
        box-shadow: 0 0 50px rgba(255, 105, 180, 0.6);
        text-align: center;
        transform: scale(0.5);
        background-image: url("https://www.transparenttextures.com/patterns/cream-paper.png");
        border: 2px solid #ff99cc;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      /* Style mới cho ảnh trong modal */
      #modal-image {
        width: 100%;
        max-height: 200px; /* Giới hạn chiều cao */
        object-fit: cover; /* Cắt ảnh đẹp */
        border-radius: 10px;
        margin-bottom: 15px;
        box-shadow: 0 4px 10px rgba(255, 105, 180, 0.3);
      }

      .modal-content h2 {
        font-family: "Dancing Script", cursive;
        color: #d63384;
        font-size: 2.2rem;
        margin-top: 0;
        margin-bottom: 10px;
        border-bottom: 1px dashed #ff99cc;
        padding-bottom: 5px;
        width: 100%;
      }
      .modal-content p {
        font-family: "Dancing Script", cursive;
        color: #555;
        font-size: 1.15rem;
        line-height: 1.6;
        margin: 0;
      }
      .close-btn {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 2rem;
        cursor: pointer;
        color: #ff99cc;
        transition: color 0.3s;
        line-height: 1;
        z-index: 10;
        background: rgba(
          255,
          255,
          255,
          0.5
        ); /* Nền mờ cho nút tắt để dễ thấy trên ảnh */
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .close-btn:hover {
        color: #d63384;
        background: rgba(255, 255, 255, 0.8);
      }
    </style>
  </head>
  <body>
    <!-- 1. MÀN HÌNH KHÓA TÌNH YÊU -->
    <div id="lock-screen" onclick="showKeypad()">
      <div class="lock-icon"><i class="fas fa-lock"></i></div>
      <div class="clock-time" id="real-time">14:02</div>
      <div class="clock-date" id="real-date">Thứ Ba, 14 tháng 2</div>

      <div class="notification-pill">
        <div class="app-icon">
          <i class="fas fa-heart" style="color: white"></i>
        </div>
        <div class="noti-content">
          <div class="noti-title">
            <span>Anh Yêu</span>
            <span class="noti-time">bây giờ</span>
          </div>
          <div class="noti-msg">Anh có một món quà bất ngờ cho em...</div>
        </div>
      </div>

      <div class="swipe-hint">Chạm để mở khóa</div>
    </div>

    <!-- 2. MÀN HÌNH KEYPAD -->
    <div id="keypad-screen">
      <div class="enter-pass-text">Nhập mật mã tình yêu</div>

      <div class="passcode-dots" id="dots-container">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>

      <div class="keypad">
        <button class="key-btn" onclick="pressKey(1)">1</button>
        <button class="key-btn" onclick="pressKey(2)">2</button>
        <button class="key-btn" onclick="pressKey(3)">3</button>
        <button class="key-btn" onclick="pressKey(4)">4</button>
        <button class="key-btn" onclick="pressKey(5)">5</button>
        <button class="key-btn" onclick="pressKey(6)">6</button>
        <button class="key-btn" onclick="pressKey(7)">7</button>
        <button class="key-btn" onclick="pressKey(8)">8</button>
        <button class="key-btn" onclick="pressKey(9)">9</button>
        <button class="key-btn transparent"></button>
        <button class="key-btn" onclick="pressKey(0)">0</button>
        <button class="key-btn transparent" onclick="deleteKey()">⌫</button>
      </div>
    </div>

    <!-- 3. Màn hình chờ 3D -->
    <div id="greeting-overlay">
      <h5 id="greet-title"></h5>
      <p id="greet-message"></p>
    </div>

    <div id="main-message"></div>
    <div id="letters-container"></div>

    <!-- Modal thiệp (Có thêm ảnh) -->
    <div id="card-modal" onclick="closeCard(event)">
      <div class="modal-content" onclick="event.stopPropagation()">
        <span class="close-btn" onclick="closeCard()">×</span>
        <!-- Thẻ ảnh mới -->
        <img id="modal-image" src="" alt="Valentine Image" />
        <h2 id="modal-title">Title</h2>
        <p id="modal-body">Content goes here...</p>
      </div>
    </div>

    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
      }
    </script>

    <script>
      // --- CLOCK LOGIC ---
      function updateClock() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, "0");
        const minutes = String(now.getMinutes()).padStart(2, "0");
        const days = [
          "Chủ Nhật",
          "Thứ Hai",
          "Thứ Ba",
          "Thứ Tư",
          "Thứ Năm",
          "Thứ Sáu",
          "Thứ Bảy",
        ];
        const dayName = days[now.getDay()];
        const date = now.getDate();
        const month = now.getMonth() + 1;

        document.getElementById("real-time").innerText = `${hours}:${minutes}`;
        document.getElementById("real-date").innerText =
          `${dayName}, ${date} tháng ${month}`;
      }
      setInterval(updateClock, 1000);
      updateClock();

      // --- KEYPAD LOGIC ---
      const SECRET_PASS = "1402";
      let currentInput = "";

      function showKeypad() {
        gsap.to("#lock-screen", {
          y: -50,
          opacity: 0,
          duration: 0.4,
          ease: "power2.in",
          onComplete: () => {
            document.getElementById("lock-screen").style.display = "none";
            const keypadEl = document.getElementById("keypad-screen");
            keypadEl.style.display = "flex";
            gsap.to(keypadEl, { opacity: 1, duration: 0.4 });
          },
        });
      }

      function pressKey(num) {
        if (currentInput.length < 4) {
          currentInput += num;
          updateDots();
          if (currentInput.length === 4) {
            setTimeout(checkPass, 200);
          }
        }
      }

      function deleteKey() {
        if (currentInput.length > 0) {
          currentInput = currentInput.slice(0, -1);
          updateDots();
        }
      }

      function updateDots() {
        const dots = document.querySelectorAll(".dot");
        dots.forEach((dot, index) => {
          if (index < currentInput.length) {
            dot.classList.add("filled");
          } else {
            dot.classList.remove("filled", "error");
          }
        });
      }

      function checkPass() {
        const dotsContainer = document.getElementById("dots-container");
        const dots = document.querySelectorAll(".dot");

        if (currentInput === SECRET_PASS) {
          gsap.to("#keypad-screen", {
            opacity: 0,
            scale: 1.1,
            duration: 0.5,
            onComplete: () => {
              document.getElementById("keypad-screen").style.display = "none";
              startMainSequence();
            },
          });
        } else {
          dots.forEach((d) => d.classList.add("error"));
          gsap.fromTo(
            dotsContainer,
            { x: -15 },
            {
              x: 15,
              duration: 0.08,
              repeat: 5,
              yoyo: true,
              onComplete: () => {
                gsap.to(dotsContainer, { x: 0 });
                currentInput = "";
                updateDots();
              },
            },
          );
        }
      }

      window.showKeypad = showKeypad;
      window.pressKey = pressKey;
      window.deleteKey = deleteKey;

      // --- CÁC HÀM CŨ (CẬP NHẬT ẢNH) ---
      const wishes = [
        {
          title: "Gửi Em",
          content:
            "Cảm ơn em đã đến và làm thế giới của anh trở nên rực rỡ. Happy Valentine!",
          image:
            "https://images.unsplash.com/photo-1518199266791-5375a83190b7?w=400&q=80",
        },
        {
          title: "My Love",
          content:
            "Mỗi lá thư là một mảnh ghép tình yêu anh dành cho em. Yêu em nhiều!",
          image:
            "https://images.unsplash.com/photo-1516589178581-6cd7833ae3b2?w=400&q=80",
        },
        {
          title: "Sweetheart",
          content:
            "Mong rằng nụ cười của em sẽ luôn tỏa sáng như bầu trời đêm nay.",
          image:
            "https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=400&q=80",
        },
        {
          title: "Forever",
          content:
            "Dù thời gian có trôi, tình cảm anh dành cho em vẫn mãi nguyên vẹn.",
          image:
            "https://images.unsplash.com/photo-1518621736915-f3b1c41bfd00?w=400&q=80",
        },
        {
          title: "Bé Yêu",
          content:
            "Em là điều ngọt ngào nhất mà anh từng có. Chúc em một ngày thật vui!",
          image:
            "https://images.unsplash.com/photo-1522858547137-f1dcec554f55?w=400&q=80",
        },
        {
          title: "Sunshine",
          content:
            "Em là ánh nắng ấm áp trong những ngày đông lạnh giá của anh.",
          image:
            "https://images.unsplash.com/photo-1474552226712-ac0f0961a954?w=400&q=80",
        },
      ];

      const imageUrls = [
        "https://cdn-icons-png.flaticon.com/512/2913/2913491.png",
        "https://cdn-icons-png.flaticon.com/512/2544/2544158.png",
        "https://cdn-icons-png.flaticon.com/512/3208/3208753.png",
      ];

      function spawnFallingLetter() {
        const container = document.getElementById("letters-container");
        const el = document.createElement("img");
        el.classList.add("falling-item");
        el.src = imageUrls[Math.floor(Math.random() * imageUrls.length)];
        const startX = Math.random() * window.innerWidth;
        const duration = 10 + Math.random() * 6;
        const rotationDir = Math.random() > 0.5 ? 1 : -1;

        gsap.set(el, { x: startX, y: -100, rotation: Math.random() * 360 });

        el.onclick = function () {
          gsap.killTweensOf(el);
          gsap.to(el, {
            scale: 2,
            opacity: 0,
            duration: 0.5,
            onComplete: () => el.remove(),
          });
          openCard(Math.floor(Math.random() * wishes.length));
        };

        container.appendChild(el);
        gsap.to(el, {
          y: window.innerHeight + 100,
          duration: duration,
          ease: "none",
          onComplete: () => {
            el.remove();
            spawnFallingLetter();
          },
        });
        gsap.to(el, {
          x: startX + (Math.random() - 0.5) * 200,
          rotation: `+=${360 * rotationDir}`,
          duration: duration,
          ease: "sine.inOut",
        });
      }

      function startFallingLetters() {
        for (let i = 0; i < 10; i++) {
          setTimeout(spawnFallingLetter, Math.random() * 6000);
        }
      }

      function openCard(index) {
        const modal = document.getElementById("card-modal");
        const content = document.querySelector(".modal-content");

        // Cập nhật nội dung và hình ảnh
        document.getElementById("modal-title").innerText = wishes[index].title;
        document.getElementById("modal-body").innerText = wishes[index].content;
        document.getElementById("modal-image").src = wishes[index].image;

        modal.style.display = "flex";
        gsap.to(modal, { duration: 0.5, opacity: 1 });
        gsap.fromTo(
          content,
          { scale: 0.5, opacity: 0, rotation: -10 },
          {
            duration: 0.6,
            scale: 1,
            opacity: 1,
            rotation: 0,
            ease: "back.out(1.7)",
          },
        );
      }

      function closeCard(event) {
        const modal = document.getElementById("card-modal");
        const content = document.querySelector(".modal-content");
        gsap.to(content, {
          duration: 0.3,
          scale: 0.5,
          opacity: 0,
          ease: "power2.in",
          onComplete: () => {
            gsap.to(modal, {
              duration: 0.2,
              opacity: 0,
              onComplete: () => {
                modal.style.display = "none";
              },
            });
          },
        });
      }

      window.closeCard = closeCard;
      window.startFallingLetters = startFallingLetters;
    </script>

    <script type="module">
      import * as THREE from "three";
      import { OrbitControls } from "three/addons/controls/OrbitControls.js";

      const CONF = {
        particleCount: 75000,
        particleSize: 0.25,
        heartColor: 0xff0000,
        heartScale: 12,
        orbitRadius: 28,
        sparkleSpeed: 4.0,
        sparkleIntensity: 0.4,
        totalIntroTime: 30.0,
        bgParticleCount: 100000,
        floorParticleCount: 20000,
        floorBaseY: -20,
        floorThickness: 15,
        floorSize: 0.9,
      };

      let animationStarted = false; // Flag quan trọng

      const scene = new THREE.Scene();
      scene.fog = new THREE.FogExp2(0x000000, 0.0018);
      const camera = new THREE.PerspectiveCamera(
        60,
        window.innerWidth / window.innerHeight,
        0.1,
        2000,
      );
      camera.position.set(0, 20, 110);

      const renderer = new THREE.WebGLRenderer({
        antialias: true,
        alpha: true,
      });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      document.body.appendChild(renderer.domElement);

      const controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.autoRotate = true;
      controls.autoRotateSpeed = 0.5;

      const pTex = (() => {
        const c = document.createElement("canvas");
        c.width = 64;
        c.height = 64;
        const x = c.getContext("2d");
        const g = x.createRadialGradient(32, 32, 0, 32, 32, 32);
        g.addColorStop(0, "rgba(255,255,255,1)");
        g.addColorStop(0.3, "rgba(255,180,220,0.8)");
        g.addColorStop(1, "rgba(0,0,0,0)");
        x.fillStyle = g;
        x.fillRect(0, 0, 64, 64);
        return new THREE.CanvasTexture(c);
      })();

      // 1. STARS BACKGROUND
      const bgGeo = new THREE.BufferGeometry();
      const bgPos = [],
        bgColors = [];
      for (let i = 0; i < CONF.bgParticleCount; i++) {
        const r = 100 + Math.random() * 400;
        const theta = Math.random() * Math.PI * 2;
        const phi = Math.acos(2 * Math.random() - 1);
        bgPos.push(
          r * Math.sin(phi) * Math.cos(theta),
          r * Math.sin(phi) * Math.sin(theta),
          r * Math.cos(phi),
        );
        const c = new THREE.Color().setHSL(Math.random() * 0.1 + 0.9, 0.7, 0.8);
        bgColors.push(c.r, c.g, c.b);
      }
      bgGeo.setAttribute(
        "position",
        new THREE.Float32BufferAttribute(bgPos, 3),
      );
      bgGeo.setAttribute(
        "color",
        new THREE.Float32BufferAttribute(bgColors, 3),
      );
      const bgMat = new THREE.PointsMaterial({
        size: 1.5,
        map: pTex,
        vertexColors: true,
        transparent: true,
        opacity: 0.5,
        blending: THREE.AdditiveBlending,
        depthWrite: false,
      });
      scene.add(new THREE.Points(bgGeo, bgMat));

      // 2. VOLUMETRIC FLOOR
      const floorGeo = new THREE.BufferGeometry();
      const floorPositions = [],
        floorColors = [],
        floorBaseHeights = [],
        floorSeeds = [];
      for (let i = 0; i < CONF.floorParticleCount; i++) {
        const angle = Math.random() * Math.PI * 2;
        const radius = Math.random() * 180;
        const x = Math.cos(angle) * radius;
        const z = Math.sin(angle) * radius;
        const baseY =
          CONF.floorBaseY + (Math.random() - 0.5) * CONF.floorThickness;
        floorPositions.push(x, baseY, z);
        floorBaseHeights.push(baseY);
        floorSeeds.push(Math.random() * Math.PI * 2);
        const col = new THREE.Color();
        const mix = Math.random();
        col.setHSL(0.9 + mix * 0.1, 0.8, 0.6 + mix * 0.3);
        const depthFactor =
          (baseY - (CONF.floorBaseY - CONF.floorThickness / 2)) /
          CONF.floorThickness;
        col.multiplyScalar(0.4 + depthFactor * 0.6);
        floorColors.push(col.r, col.g, col.b);
      }
      floorGeo.setAttribute(
        "position",
        new THREE.Float32BufferAttribute(floorPositions, 3),
      );
      floorGeo.setAttribute(
        "color",
        new THREE.Float32BufferAttribute(floorColors, 3),
      );
      const floorMat = new THREE.PointsMaterial({
        size: CONF.floorSize,
        map: pTex,
        vertexColors: true,
        transparent: true,
        opacity: 0.7,
        blending: THREE.AdditiveBlending,
        depthWrite: false,
      });
      const floorMesh = new THREE.Points(floorGeo, floorMat);
      scene.add(floorMesh);

      // Heart
      const hGeo = new THREE.BufferGeometry();
      const curr = [],
        init = [],
        final = [],
        sched = [],
        cols = [],
        baseCols = [],
        offs = [];
      const baseCol = new THREE.Color(CONF.heartColor);
      let i = 0;
      while (i < CONF.particleCount) {
        const x = Math.random() * 3 - 1.5,
          y = Math.random() * 3 - 1.5,
          z = Math.random() * 3 - 1.5;
        if (
          (x * x + 2.25 * z * z + y * y - 1) ** 3 -
            x * x * y * y * y -
            0.1125 * z * z * y * y * y <
          0
        ) {
          final.push(
            x * CONF.heartScale,
            y * CONF.heartScale,
            z * CONF.heartScale,
          );
          const r = 300 + Math.random() * 200;
          const th = Math.random() * Math.PI * 2,
            ph = Math.random() * Math.PI;
          init.push(
            r * Math.sin(ph) * Math.cos(th),
            r * Math.sin(ph) * Math.sin(th),
            r * Math.cos(ph),
          );
          curr.push(init[i * 3], init[i * 3 + 1], init[i * 3 + 2]);
          sched.push({
            s: Math.random() * (CONF.totalIntroTime - 3),
            d: 4 + Math.random() * 1.5,
          });
          const c = baseCol.clone();
          c.multiplyScalar(1 + y * 0.2 + (Math.random() - 0.5) * 0.1);
          if (c.g > 0.1) c.g = 0;
          cols.push(c.r, c.g, c.b);
          baseCols.push(c.r, c.g, c.b);
          offs.push(Math.random() * Math.PI * 2);
          i++;
        }
      }
      hGeo.setAttribute("position", new THREE.Float32BufferAttribute(curr, 3));
      hGeo.setAttribute("color", new THREE.Float32BufferAttribute(cols, 3));
      const hMesh = new THREE.Points(
        hGeo,
        new THREE.PointsMaterial({
          size: CONF.particleSize,
          map: pTex,
          vertexColors: true,
          blending: THREE.AdditiveBlending,
          depthWrite: false,
          transparent: true,
          opacity: 0.9,
        }),
      );
      scene.add(hMesh);

      // Text 3D
      function createTxt(t) {
        const c = document.createElement("canvas");
        const x = c.getContext("2d");
        c.width = 800;
        c.height = 200;
        x.font = "bold 100px 'Segoe UI'";
        x.fillStyle = "white";
        x.textAlign = "center";
        x.textBaseline = "middle";
        x.fillText(t, 500, 100);
        const d = x.getImageData(0, 0, 1000, 200);
        const p = [],
          cl = [];
        const co = new THREE.Color("#ff66aa");
        for (let j = 0; j < 200; j += 3)
          for (let k = 0; k < 1000; k += 3)
            if (d.data[(j * 1000 + k) * 4 + 3] > 128) {
              p.push((k - 500) * 0.045, -(j - 100) * 0.045 - 18, 0);
              const nc = co.clone();
              nc.r += (Math.random() - 0.5) * 0.1;
              cl.push(nc.r, nc.g, nc.b);
            }
        const g = new THREE.BufferGeometry();
        g.setAttribute("position", new THREE.Float32BufferAttribute(p, 3));
        g.setAttribute("color", new THREE.Float32BufferAttribute(cl, 3));
        return { g, c: cl };
      }
      const tDat = createTxt("Happy Valentine's Day");
      const tMat = new THREE.PointsMaterial({
        size: 0.2,
        map: pTex,
        vertexColors: true,
        transparent: true,
        opacity: 0,
        blending: THREE.AdditiveBlending,
        depthWrite: false,
      });
      const tMesh = new THREE.Points(tDat.g, tMat);
      // scene.add(tMesh); // Bỏ comment nếu muốn hiện chữ 3D

      // Orbit
      const rGrp = new THREE.Group();
      scene.add(rGrp);
      const oMat = new THREE.MeshBasicMaterial({
        color: 0xff99cc,
        transparent: true,
        opacity: 0,
        blending: THREE.AdditiveBlending,
      });
      // rGrp.add(new THREE.Mesh(new THREE.TorusGeometry(CONF.orbitRadius, 0.05, 16, 100), oMat).rotateX(Math.PI / 2));

      // --- KỊCH BẢN CHÍNH ---
      const clock = new THREE.Clock();
      let startTime = null;

      function startMainSequence() {
        const overlay = document.getElementById("greeting-overlay");
        overlay.style.display = "flex";

        gsap
          .timeline()
          .set("#greeting-overlay", { opacity: 1 })
          .to("#greet-title", {
            duration: 2.5,
            text: "Gửi đến người anh thương",
            ease: "none",
            opacity: 1,
          })
          .to(
            "#greet-message",
            {
              duration: 6,
              text: "Đây là món quà nhỏ anh dành tặng em trong ngày Valentine. Hy vọng nó sẽ mang lại nụ cười và niềm vui cho em!",
              ease: "none",
              opacity: 1,
            },
            "+=0.5",
          )
          .to("#greeting-overlay", {
            duration: 2,
            opacity: 0,
            delay: 1,
            onComplete: () => {
              document.getElementById("greeting-overlay").style.display =
                "none";
              animationStarted = true;
              startTime = clock.getElapsedTime();

              setTimeout(
                () => {
                  const msgEl = document.getElementById("main-message");
                  gsap.to(msgEl, { opacity: 1, duration: 1 });
                  gsap.to(msgEl, {
                    text: "Gửi em, người con gái anh yêu thương nhất. Cảm ơn em đã đến và mang lại ánh sáng cho cuộc đời anh. Mỗi khoảnh khắc bên em đều là một món quà vô giá. Chúc em một ngày Valentine thật hạnh phúc và tràn ngập yêu thương! ❤️",
                    duration: 20,
                    ease: "none",
                    onComplete: () => {
                      gsap.to(msgEl, {
                        opacity: 0,
                        delay: 6,
                        duration: 1.5,
                        onComplete: () => {
                          window.startFallingLetters();
                        },
                      });
                    },
                  });
                },
                (CONF.totalIntroTime + 1.5) * 1000,
              );
            },
          });
      }

      window.startMainSequence = startMainSequence;

      // Animation Loop
      let cOpc = 0;
      function easeOutCubic(x) {
        return 1 - Math.pow(1 - x, 3);
      }

      function animate() {
        requestAnimationFrame(animate);
        const now = clock.getElapsedTime();

        if (floorMesh) {
          const fPos = floorMesh.geometry.attributes.position.array;
          for (let i = 0; i < CONF.floorParticleCount; i++) {
            const i3 = i * 3;
            const x = fPos[i3];
            const z = fPos[i3 + 2];
            const baseY = floorBaseHeights[i];
            const dist = Math.sqrt(x * x + z * z);
            const wave =
              Math.sin(now * 0.6 + dist * 0.04 + floorSeeds[i]) * 2.8;
            fPos[i3 + 1] = baseY + wave;
          }
          floorMesh.geometry.attributes.position.needsUpdate = true;
          floorMat.opacity = 0.5 + Math.sin(now * 0.3) * 0.2;
        }

        if (!animationStarted) {
          renderer.render(scene, camera);
          return;
        }

        const elp = now - startTime;

        if (elp < CONF.totalIntroTime + 2) {
          const pos = hMesh.geometry.attributes.position.array;
          for (let i = 0; i < CONF.particleCount; i++) {
            const s = sched[i];
            if (elp >= s.s) {
              const p = elp < s.s + s.d ? easeOutCubic((elp - s.s) / s.d) : 1;
              const i3 = i * 3;
              pos[i3] = init[i3] + (final[i3] - init[i3]) * p;
              pos[i3 + 1] = init[i3 + 1] + (final[i3 + 1] - init[i3 + 1]) * p;
              pos[i3 + 2] = init[i3 + 2] + (final[i3 + 2] - init[i3 + 2]) * p;
            }
          }
          hMesh.geometry.attributes.position.needsUpdate = true;
        }

        if (elp > CONF.totalIntroTime * 0.8) {
          hMesh.scale.setScalar(
            1 + Math.pow(Math.sin(clock.getElapsedTime() * 0.5), 2) * 0.6,
          );
          if (cOpc < 1) {
            cOpc += 0.003;
            if (cOpc > 1) cOpc = 1;
            oMat.opacity = cOpc * 0.6;
            tMat.opacity = cOpc;
          }
        }

        const cols = hMesh.geometry.attributes.color.array;
        for (let i = 0; i < CONF.particleCount; i++) {
          const f =
            1 +
            Math.sin(now * CONF.sparkleSpeed + offs[i]) * CONF.sparkleIntensity;
          const i3 = i * 3;
          cols[i3] = Math.max(0, baseCols[i3] * f);
          cols[i3 + 1] = Math.max(0, baseCols[i3 + 1] * f);
          cols[i3 + 2] = Math.max(0, baseCols[i3 + 2] * f);
        }
        hMesh.geometry.attributes.color.needsUpdate = true;

        if (tMat.opacity > 0) {
          const tc = tMesh.geometry.attributes.color.array;
          const tbc = tDat.c;
          for (let i = 0; i < tbc.length / 3; i++) {
            const f = 1 + Math.sin(now * 5 + i) * 0.5;
            const i3 = i * 3;
            tc[i3] = Math.max(0, tbc[i3] * f);
            tc[i3 + 1] = Math.max(0, tbc[i3 + 1] * f);
            tc[i3 + 2] = Math.max(0, tbc[i3 + 2] * f);
          }
          tMesh.geometry.attributes.color.needsUpdate = true;
        }

        rGrp.rotation.y = Math.sin(now * 0.1) * 0.1;
        controls.update();
        renderer.render(scene, camera);
      }
      animate();
      window.addEventListener("resize", () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });
    </script>
  </body>
</html>
